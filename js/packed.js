!function(t){return app=t.app||{},app.QUESTION_TYPE={MULTI:"multi",SINGLE:"single"},app.QUIZ_TYPE={ORDINARY:"ordinary",TIME_LIMIT:"time_limit",CHALLENGE:"challenge"},app.DOWNLOAD_TIMEOUT=3e3,app.DOWNLOAD_TRIGGER=30,t.app=app,app}(window),function(t,e,i,n){return app=t.app||{},app.ApplicationView=n.View.extend({el:e("#app_container"),dataRoot:"/data/",apiRoot:"/rest/",initialize:function(t){this.game_code=t.game_code,this.gameDataRoot=this.dataRoot+this.game_code+"/",this.quizConfig=t.config},run:function(){var t,e=parseInt(localStorage.getItem(this.game_code+"_count"))||0,i=parseInt(this.quizConfig.max_chances);if(e>i)t=new app.RejectionNoMoreChanceView;else{var n=new Date,o=new Date(this.quizConfig.start_at),s=new Date(this.quizConfig.end_at);o>n?t=new app.RejectionTooEarlyView:n>s&&(t=new app.RejectionTooLateView)}t?this.loadView(t):this.prepareQuiz()},loadView:function(t){this.view&&(this.view.close?this.view.close():this.view.remove()),this.view=t,this.$el.append(this.view.render().el)},loadStyle:function(){var t,i=this.quizConfig.type;switch(i){case app.QUIZ_TYPE.ORDINARY:t="theme1/css/main.css";break;case app.QUIZ_TYPE.TIME_LIMIT:t="theme2/css/main.css";break;case app.QUIZ_TYPE.CHALLENGE:t="theme3/css/main.css";break;default:throw new Error("Unknown Quiz Type")}console.log("style",t),e("head").append('<link rel="stylesheet" type="text/css" href="'+t+'"/>')},prepareQuiz:function(){var t=new app.WelcomeView({content:this.quizConfig.welcome,infoFields:this.quizConfig.info_fields,quizId:this.quizConfig.id});this.listenToOnce(t,"startQuiz",this.startQuiz),this.loadView(t)},startQuiz:function(t){var e,i=this.quizConfig.type;switch(i){case app.QUIZ_TYPE.ORDINARY:e=app.OrdinaryQuizView;break;case app.QUIZ_TYPE.TIME_LIMIT:e=app.TimeLimitQuizView;break;case app.QUIZ_TYPE.CHALLENGE:e=app.ChallengeQuizView;break;default:throw new Error("Unknown Quiz Type")}var n=new e({config:this.quizConfig,gameDataRoot:this.gameDataRoot}),o=parseInt(localStorage.getItem(this.game_code+"_count"))||0;localStorage.setItem(this.game_code+"_count",o+1),this.listenToOnce(n,"finishQuiz",this.finishQuiz),this.loadView(n)},finishQuiz:function(){console.log("结束");var t=new app.RankView;this.loadView(t)}}),t.app=app,app}(this,$,_,Backbone),function(t,e,i,n){return app=t.app||{},app.ModalView=n.View.extend({tagName:"div",className:"modal",template:i.template(e("#tpl_modal").html()),events:{"click .submit":"close"},initialize:function(t){this.options=t,this.callback=t.callback},render:function(){return this.$el.html(this.template(this.options)),this},close:function(){i.isFunction(this.callback)&&this.callback(),this.remove()}}),app.modal=function(t){var i=new app.ModalView(t);e("body").append(i.render().el)},t.app=app,app}(window,$,_,Backbone),function(t,e){return app=t.app||{},app.Option=e.Model.extend({}),app.Question=e.Model.extend({defaults:{selected:[],timeout:!1,answered:!1},isCorrect:function(){if(!this.get("answered"))return!1;var t=this.get("answer"),e=_(this.get("selected")).pluck("id");return t&&e&&t.length===e.length?0===_.difference(t,e).length:!1},getAnswerCodes:function(){var t=this.get("answer"),e=this.get("options");return _.map(t,function(t){return e.get(t).get("code")})}}),app.OptionCollection=e.Collection.extend({model:app.Option}),app.QuestionCollection=e.Collection.extend({model:app.Question,totalPoints:function(t){var e=0;return this.each(function(i){i.get("answered")&&i.isCorrect()&&(e+=t[i.get("type")])},this),e}}),t.app=app,app}(window,Backbone),function(t,e,i){return app=t.app||{},app.RejectionView=i.View.extend({render:function(){return this.$el.html(this.template()),this}}),app.RejectionTooEarlyView=app.RejectionView.extend({template:e.template($("#tpl_too_early").html())}),app.RejectionTooLateView=app.RejectionView.extend({template:e.template($("#tpl_too_late").html())}),app.RejectionNoMoreChanceView=app.RejectionView.extend({template:e.template($("#tpl_no_more_chance").html())}),app.WelcomeView=i.View.extend({tagName:"div",className:"welcome",template:e.template($("#tpl_welcome").html()),events:{"click .submit":"onSubmit"},initialize:function(t){this.content=t.content,this.infoFields=t.infoFields,this.quizId=t.quizId},render:function(){return this.$el.html(this.template({content:this.content,infoFields:this.infoFields})),this},onSubmit:function(t){var i=e.unzip(this.infoFields)[0],n=!1,o=[];n=i.length?e(this.$("input")).chain().filter(function(t){return e(i).indexOf(t.name)>=0}).every(function(t){return t.value.length>0?(o.push([t.name,t.value]),localStorage.setItem(t.name,t.value),!0):!1}).value():!0,n?this.trigger("startQuiz",o):app.modal({message:"亲，需填完信息才能开始哦~",emotion:"tricky",button:{text:"关闭"}})}}),t.app=app,app}(this,_,Backbone),function(t,e,i){return app=t.app||{},app.QuestionView=i.View.extend({tagName:"div",className:"question",template:e.template($("#tpl_question").html()),events:{"click .submit":"onSubmit"},initialize:function(t){var e=this.model.get("options"),i=new app.OptionCollection(e);i.each(function(t,e){t.set("code",String.fromCharCode(65+e))}),this.model.set("options",i),this.listenTo(i,"change:checked",this.toggleChecked),this.on("timeout",this.onTimeout,this),this.optionViews=[]},render:function(){var t=this.model.toJSON();return this.$el.html(this.template(t)),this.renderAllOptions(),this},renderOption:function(t){if(this.model.get("type")==app.QUESTION_TYPE.MULTI)var e=app.MultiSelectionView;else var e=app.SingleSelectionView;var i=new e({model:t});this.optionViews.push(i),this.$(".option_list").append(i.render().el)},renderAllOptions:function(){var t=e.shuffle(this.model.get("options").models);return e.each(t,this.renderOption,this),this},toggleChecked:function(t){this.model.get("type")==app.QUESTION_TYPE.MULTI?this.model.set("selected",this.model.get("options").filter("checked")):this.model.set("selected",[t])},onSubmit:function(){return e.isEmpty(this.model.get("selected"))?!1:void this.finish()},onTimeout:function(){this.model.set("timeout",!0),this.finish()},finish:function(){this.model.set("answered",!0),this.trigger("finish",this.model)},close:function(){e.each(this.optionViews,function(t){t.remove()}),this.remove()}}),app.OptionView=i.View.extend({tagName:"div",className:"question_option",events:{"change input":"toggle"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},toggle:function(){var t=this.model.get("checked");this.model.set("checked",!t)}}),app.SingleSelectionView=app.OptionView.extend({template:e.template($("#tpl_option_single").html())}),app.MultiSelectionView=app.OptionView.extend({template:e.template($("#tpl_option_multi").html())}),t.app=app,app}(this,_,Backbone),function(t,e,i,n){return app=t.app||{},app.QuizBaseView=n.View.extend({tagName:"div",className:"quiz",template:i.template(e("#tpl_quiz").html()),initialize:function(t){this.config=t.config,this.gameDataRoot=t.gameDataRoot,this.questions=new app.QuestionCollection},render:function(){return this.$el.html(this.template({timeLimit:this.timeLimit})),this.listenToOnce(this.questions,"add",this.start),this.listenTo(this.questions,"change:answered",this.updatePanel),this.download(),this},close:function(){this.questionView&&this.questionView.close(),this.remove()},download:function(){throw new Error("Not implemented")},start:function(){this.preQuiz&&this.preQuiz(),this.play()},play:function(){this.currentQuestion=i.sample(this.questions.filter({answered:!1})),this.preQuestion&&this.preQuestion(),this.questionView&&this.questionView.remove(),this.questionView=new app.QuestionView({model:this.currentQuestion}),this.listenToOnce(this.questionView,"finish",this.finishQuestion),this.$el.append(this.questionView.render().el),console.log(this.currentQuestion.getAnswerCodes().join())},timeLimit:function(){return this.config.time_per_question||null},updatePanel:function(){var t=this.questions.filter({answered:!0}).length,e=this.config.question_points,i=this.questions.totalPoints(e);this.$("#count").html(t),this.$("#points").html(i),console.log("update panel",t,i)},finishQuestion:function(){this.postQuestion&&this.postQuestion();var t=this.currentQuestion,e=this.config.show_answer||!1,n=t.get("timeout"),o=t.isCorrect()?"亲，答题正确，好厉害哦~":n?"亲，回答超时，注意答题时间哦~":"亲，答题错误。",s=n?"sweat":t.isCorrect()?"tongue":"tears";e&&(o+="正确答案:"+t.getAnswerCodes().join()+"。"),this.hasNext()?app.modal({message:o,button:{text:"下一题"},emotion:s,callback:i.bind(this.play,this)}):(this.postQuiz&&this.postQuiz(),app.modal({message:o+"游戏结束",button:{text:"查看结果"},emotion:s,callback:i.bind(function(){this.trigger("finishQuiz")},this)}))},startTimer:function(){var t=0,e=this.timeLimit();this.updateTimer(e);var n=function(){remaining=e-++t,this.updateTimer(remaining),remaining<1&&this.timeout()};this.timer=setInterval(i.bind(n,this),1e3)},updateTimer:function(t){function e(t){var e=parseInt(t/60),t=t%60;return i.map([e,t],function(t){return t>9?""+t:"0"+t}).join(":")}this.$("#timer").html(e(t))},timeout:function(){this.clearTimer(),this.questionView.trigger("timeout")},clearTimer:function(){this.timer&&clearInterval(this.timer),this.timer=null},hasNext:function(){throw new Error("Not implemented")}}),app.OrdinaryQuizView=app.QuizBaseView.extend({preQuestion:function(){this.timeLimit()&&this.startTimer()},postQuestion:function(){this.clearTimer()},download:i.throttle(function(){if(!this.unloadedFiles){var t=i.clone(this.config.question_files);this.unloadedFiles=i.mapObject(t,function(t){return i.shuffle(t)})}var n=this.questions.countBy("type"),o=i.findKey(this.config.count,function(t,e){var i=n[e]||0;return t>i});if(!o)return this.questions;if(navigator.onLine){var s=this.config.count[o]-(n[o]||0),a=this.unloadedFiles[o].pop();e.ajax({dataType:"json",url:this.gameDataRoot+a,timeout:app.DOWNLOAD_TIMEOUT}).done(i.bind(function(t){var e=i.sample(t.objects,s);this.questions.add(e)},this))}this.download()},app.DOWNLOAD_TIMEOUT),hasNext:function(){return this.questions.any({answered:!1})}}),app.ContinuousQuizView=app.QuizBaseView.extend({download:i.throttle(function(){if(i.isEmpty(this.unloadedFiles)){var t=i.clone(this.config.question_files);this.unloadedFiles=i(t).chain().values().flatten().shuffle().value()}if(navigator.onLine){var n=this.unloadedFiles.pop();e.ajax({dataType:"json",url:this.gameDataRoot+n,timeout:app.DOWNLOAD_TIMEOUT}).done(i.bind(function(t){this.questions.add(t.objects)},this))}},app.DOWNLOAD_TIMEOUT),postQuestion:function(){var t=this.questions.filter({answered:!1});t.length<app.DOWNLOAD_TRIGGER&&this.download()}}),app.TimeLimitQuizView=app.ContinuousQuizView.extend({timeLimit:function(){return this.config.time_per_quiz||300},preQuiz:function(){this.timeLimit()&&this.startTimer(),this.startTime=new Date},postQuiz:function(){this.clearTimer()},hasNext:function(){var t=this.timeLimit();return current=new Date,console.log("time limit",t,(current-this.startTime)/1e3),current-this.startTime<1e3*t}}),app.ChallengeQuizView=app.ContinuousQuizView.extend({timeLimit:function(){return null},hasNext:function(){return this.currentQuestion.isCorrect()}}),t.app=app,app}(this,$,_,Backbone),function(t,e,i){return app=t.app||{},app.RankView=i.View.extend({tagName:"div",className:"rank",template:e.template($("#tpl_rank").html()),render:function(){return this.$el.html(this.template({points:0,maxPoints:0,bestPoints:100,rank:2,bestRank:1})),this}}),t.app=app,app}(this,_,Backbone);
//# sourceMappingURL=packed.js.map
